<!DOCTYPE html>

<html lang="en">

<head>

	<meta charset="utf-8" />

	<title>{{ site_title }} Administration</title>

	<meta name="robots" content="noindex, nofollow" />

	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="stylesheet" type="text/css" href="{{ base_url }}/plugins/pico_edit/styles.css" />

</head>

<body class="grid-wrap w-100 menu-fixed">

	<header class="grid-wrap txt-w-500 color-white bg-dark-gray padding-left-m padding-right-m">
			
		<div class="grid-item w-30">

			<a href="#main-menu" class="menu-toggle">&#9776;</a>

			<h1 class="txt-uppercase txt-w-700 txt-s">
				<!-- <a href="{{ base_url }}" id="logo"> -->{{ site_title }} Administration<!-- </a> -->
			</h1>

		</div>

		<nav id="main-menu" class="controls grid-item w-70 txt-m trans txt-right">

			<a href="#" class="menu-close bg-black color-white">&#9932;</a>

			<ul class="txt-uppercase txt-w-700">

				<li><a href="#" type="button" class="pure-button new" title="New">New +</a></li>

				<li><a href="#" type="button" class="pure-button clearcachebutton" title="Clear Cache">Clear Cache</a></li>

				<li><a href="{{ pico_edit_url }}/logout" type="button" class="pure-button logout" id="logout" title="Logout">Logout</a></li>

			</ul>
		
		</div>

	</header>

	<section id="main" class="grid-wrap" >

		<div class="grid-item w-20">

			<ul class="nav">

				{% if config.pico_edit_options %}

					<li class="padding-s display-block"><a href="#" data-url="conf" class="post page-options"><i>config options</i></a></li>

				{% endif %} 

				{% if config.pico_edit_404 %}

					<li class="padding-s display-block"><a href="#" data-url="/404" class="post page-404"><i>404</i></a></li>

				{% endif %} 

				{% for page in pages %}

					<li class="padding-xs padding-left-s padding-right-s display-block">
						
						<a href="#" data-url="{{ page.id }}" class="post">/{{ page.id }}</a>
						
						<a href="#" data-url="{{ page.id }}" class="delete float-right margin-left-s" title="Delete">&#9932;</a>

						<a href="{{ page.url }}" target="_blank" class="float-right" title="View">View</a>

					</li>

				{% endfor %}

			</ul>

		</div>


		<!-- Editor -->
		<div id="epiceditor" class="grid-item w-60"></div>


		<div class="controls grid-item w-20 txt-w-700 txt-uppercase	">

			<a href="#" type="button" class="savebutton display-block padding-s bg-success color-white" title="Save">Save</a>

			<a href="#preview" id="preview-btn" class="display-block padding-s bg-info color-white">Preview</a>

			<a href="#edit" id="edit-btn" class="display-block padding-s bg-disable color-white">Edit</a>

		</div>

	</section>

<!-- 	<footer class="grid-wrap">
		
		<div class="grid-item w-100	bg-dark-gray color-white padding-m">
			
			<p class="txt-s">Proudly designed and developed by <a href="https://elegrad.com" target="_blank">Elegrad</a></p>

		</div>

	</footer> -->

	<!-- Save snackbar -->
	<div id="saving" class="txt-w-500 txt-l bg-success color-white padding-m position-fixed bottom-0 left-0 w-100 trans hidden">Saving...</div>

	<script src="{{ base_url }}/plugins/pico_edit/libs/jquery-1.12.3.min.js"></script>

	<script src="{{ base_url }}/plugins/pico_edit/libs/epiceditor/js/epiceditor.min.js"></script>

	<script>
		
		$(document).ready(function() {

			// Logout is REQUIRED
			window.onbeforeunload = function() {

				return "Did you log out?"

			}

			// Prevent close warning for logout button
			document.getElementById('logout').onclick = function() {

				window.onbeforeunload = null;

			};

			// Switch editor to preview mode
			$("#preview-btn").click(function() {

				editor.preview();

			});

			// Switch editor to edit mode
			$("#edit-btn").click(function() {

				editor.edit();

			});

			var unsaved = false;

			var editor = new EpicEditor({

				container: 'epiceditor',

				basePath: '{{ base_url }}/plugins/pico_edit/libs/epiceditor',

				clientSideStorage: false,

				useNativeFullscreen: false,

				file: {

					name: 'epiceditor',

					defaultContent: '',

					autoSave: 5000

				},

				theme: {

					base: '{{ base_url }}/plugins/pico_edit/libs/epiceditor/themes/base/epiceditor.css',

					preview: '{{ base_url }}/plugins/pico_edit/libs/epiceditor/themes/preview/github.css',

					editor: '{{ base_url }}/plugins/pico_edit/libs/epiceditor/themes/editor/epic-dark.css?v=1'

				},

				button: {

					preview: false,

					fullscreen: false,

					bar: false

				},

				focusOnLoad: true

			}).load();

			$.post('{{ pico_edit_url }}/open', {

				file: "index"

			}, function(data) {

				$('#epiceditor').data('currentFile', "index");

				editor.importFile('epiceditor', data);

				unsaved = false;

				document.title = document.title.replace(' *', '');

			});

			$(editor.getElement('editor')).on('keyup', function() {

				if (!unsaved) {

					unsaved = true;

					document.title += ' *';

				}

			});

			// New
			$('.controls .new').on('click', function(e) {

				e.preventDefault();

				var title = prompt('Enter page title; optionally with path, example: sub folder/my page', '');

				if (title != null && title != '') {

					$.post('{{ pico_edit_url }}/new', {

						title: title

					}, function(data) {

						if (data.error) {

							alert(data.error);

						} else {

							$('.nav .post').removeClass('open');

							$('#epiceditor').data('currentFile', data.file);

							editor.importFile('epiceditor', data.content);

							unsaved = false;

							document.title = document.title.replace(' *', '');

							$('.nav').append('<li><a href="#" data-url="' + data.file + '" class="post list-group-item">/' + data.file + '</a></li><li><a href="' + data.url + '" target="_blank" class="view" title="View"><i class="fa fa-eye" aria-hidden="true"></i></a></li><li><a href="#" data-url="' + data.file + '" class="delete" title="Delete"><i class="fa fa-trash-o" aria-hidden="true"></i></a></li>')

						}

					}, 'json');

				}

			});

			// Open post
			$('.nav').on('click', '.post', function(e) {

				e.preventDefault();

				if (unsaved && !confirm('You have unsaved changes. Are you sure you want to leave this post?')) return false;

				$('.nav .post, .post').removeClass('open');

				$(this).addClass('open');

				var fileUrl = $(this).attr('data-url');

				$.post('{{ pico_edit_url }}/open', {

					file: fileUrl

				}, function(data) {

					$('#epiceditor').data('currentFile', fileUrl);

					editor.importFile('epiceditor', data);

					unsaved = false;

					document.title = document.title.replace(' *', '');

				});

			});

			// Save post
			editor.on('autosave', function() {

				$('#saving').text('Saving...').addClass('visible');

				$.post('{{ pico_edit_url }}/save', {

					file: $('#epiceditor').data('currentFile'),

					content: editor.exportFile()

				}, function(data) {

					$('#saving').text('Saved');

					unsaved = false;

					document.title = document.title.replace(' *', '');

					setTimeout(function() {

						$('#saving').removeClass('visible');

					}, 1000);

				});

			});

			// Save on preview
			editor.on('preview', function() {

				editor.emit('autosave');

			});

			// btn - Delete
			$('.nav').on('click', '.delete', function(e) {

				e.preventDefault();

				if (!confirm('Are you sure you want to delete this file?')) return false;

				$('.nav .post').removeClass('open');

				var tr = $(this).parents('tr');

				var fileUrl = $(this).attr('data-url');

				$.post('{{ pico_edit_url }}/delete', {

					file: fileUrl

				}, function(data) {

					tr.remove();

					$('#epiceditor').data('currentFile', '');

					editor.importFile('epiceditor', '');

					unsaved = false;

					document.title = document.title.replace(' *', '');

				});

			});

			// btn - Save
			$('.controls').on('click', '.savebutton', function(e) {

				e.preventDefault();

				$('#saving').text('Saving...').addClass('visible');

				$.post('{{ pico_edit_url }}/save', {

					file: $('#epiceditor').data('currentFile'),

					content: editor.exportFile()

				}, function(data) {

					$('#saving').text('Saved');

					unsaved = false;

					document.title = document.title.replace(' *', '');

					setTimeout(function() {

						$('#saving').removeClass('visible');

					}, 1000);

				});

			});

			// btn - Clear cache
			$('.controls').on('click', '.clearcachebutton', function(e) {

				e.preventDefault();

				$('#saving').text('Clearing...').addClass('visible');

				$.post('{{ pico_edit_url }}/clearcache', {}, function(data) {

					$('#saving').text('Cache cleared');

					setTimeout(function() {

						$('#saving').removeClass('visible');

					}, 1000);

				});

			});


		});

	</script>

</body>

</html>